<template>
  <div class="app-page">
    <!-- APP é ­éƒ¨ -->
    <header class="app-header">
      <router-link to="/" class="text-2xl">â†</router-link>
      <h1 class="text-lg font-bold text-[var(--color-text)]">è¨­å®š</h1>
      <div class="w-8"></div>
    </header>

    <!-- å¯æ»¾å‹•å…§å®¹å€ -->
    <div class="app-content-scroll">
      <div class="p-4 space-y-4">
        <!-- å¤–è§€ä¸»é¡Œè¨­å®šï¼ˆå·²ç¦ç”¨ï¼Œå›ºå®šç‚ºæ˜äº®æ¨¡å¼ï¼‰
        <div class="card p-4">
          <h3 class="font-semibold text-[var(--color-text)] mb-4">ğŸ¨ å¤–è§€ä¸»é¡Œ</h3>
          
          <div class="grid grid-cols-3 gap-2">
            <button
              @click="settingsStore.setThemeMode('light')"
              class="flex flex-col items-center gap-1 p-3 rounded-xl border-2 transition-all"
              :class="settingsStore.themeMode === 'light' 
                ? 'border-[var(--color-primary)] bg-[var(--color-primary-bg)]' 
                : 'border-[var(--color-border)]'"
            >
              <span class="text-xl">â˜€ï¸</span>
              <span class="text-sm text-[var(--color-text)]">æ·ºè‰²</span>
            </button>
            
            <button
              @click="settingsStore.setThemeMode('dark')"
              class="flex flex-col items-center gap-1 p-3 rounded-xl border-2 transition-all"
              :class="settingsStore.themeMode === 'dark' 
                ? 'border-[var(--color-primary)] bg-[var(--color-primary-bg)]' 
                : 'border-[var(--color-border)]'"
            >
              <span class="text-xl">ğŸŒ™</span>
              <span class="text-sm text-[var(--color-text)]">æ·±è‰²</span>
            </button>
            
            <button
              @click="settingsStore.setThemeMode('system')"
              class="flex flex-col items-center gap-1 p-3 rounded-xl border-2 transition-all"
              :class="settingsStore.themeMode === 'system' 
                ? 'border-[var(--color-primary)] bg-[var(--color-primary-bg)]' 
                : 'border-[var(--color-border)]'"
            >
              <span class="text-xl">ğŸ–¥ï¸</span>
              <span class="text-sm text-[var(--color-text)]">è‡ªå‹•</span>
            </button>
          </div>
        </div>
        -->

        <!-- è¨“ç·´ç›®æ¨™è¨­å®š -->
        <div class="card">
          <TrainingGoalSettings />
        </div>

        <!-- è¢å¹•æ–¹å‘è¨­å®š -->
        <div class="card p-4">
          <h3 class="font-semibold text-[var(--color-text)] mb-4">ğŸ“± è¢å¹•æ–¹å‘</h3>
          
          <div class="grid grid-cols-3 gap-2">
            <button
              @click="settingsStore.setOrientationPreference('portrait')"
              class="flex flex-col items-center gap-1 p-3 sm:p-4 rounded-xl border-2 transition-all min-h-[60px] sm:min-h-[80px]"
              :class="settingsStore.orientationPreference === 'portrait'
                ? 'border-[var(--color-primary)] bg-[var(--color-primary-bg)]'
                : 'border-[var(--color-border)]'"
            >
              <span class="text-xl sm:text-2xl">ğŸ“±</span>
              <span class="text-xs sm:text-sm text-[var(--color-text)]">ç›´å‘</span>
            </button>

            <button
              @click="settingsStore.setOrientationPreference('landscape')"
              class="flex flex-col items-center gap-1 p-3 sm:p-4 rounded-xl border-2 transition-all min-h-[60px] sm:min-h-[80px]"
              :class="settingsStore.orientationPreference === 'landscape'
                ? 'border-[var(--color-primary)] bg-[var(--color-primary-bg)]'
                : 'border-[var(--color-border)]'"
            >
              <span class="text-xl sm:text-2xl">ğŸ“º</span>
              <span class="text-xs sm:text-sm text-[var(--color-text)]">æ©«å‘</span>
            </button>

            <button
              @click="settingsStore.setOrientationPreference('auto')"
              class="flex flex-col items-center gap-1 p-3 sm:p-4 rounded-xl border-2 transition-all min-h-[60px] sm:min-h-[80px]"
              :class="settingsStore.orientationPreference === 'auto'
                ? 'border-[var(--color-primary)] bg-[var(--color-primary-bg)]'
                : 'border-[var(--color-border)]'"
            >
              <span class="text-xl sm:text-2xl">ğŸ”„</span>
              <span class="text-xs sm:text-sm text-[var(--color-text)]">è‡ªå‹•</span>
            </button>
          </div>
          
          <!-- ä¸æ”¯æ´æç¤º -->
          <p 
            v-if="!settingsStore.orientationSupported" 
            class="text-xs text-[var(--color-text-muted)] mt-3 flex items-center gap-1"
          >
            <span>âš ï¸</span>
            <span>æ‚¨çš„è£ç½®/ç€è¦½å™¨ä¸æ”¯æ´è‡ªå‹•æ–¹å‘é–å®šï¼Œè«‹æ‰‹å‹•æ—‹è½‰è¢å¹•</span>
          </p>
        </div>

        <!-- éŸ³æ•ˆè¨­å®š -->
        <div class="card p-4">
          <h3 class="font-semibold text-[var(--color-text)] mb-4">ğŸ”Š éŸ³æ•ˆè¨­å®š</h3>
          
          <!-- éŠæˆ²éŸ³æ•ˆ -->
          <div class="flex items-center justify-between mb-3">
            <div>
              <div class="text-sm font-medium text-[var(--color-text)]">éŠæˆ²éŸ³æ•ˆ</div>
            </div>
            <button
              @click="settingsStore.toggleSound()"
              class="toggle-switch"
              :class="{ 'toggle-on': settingsStore.soundEnabled }"
            >
              <span class="toggle-thumb"></span>
            </button>
          </div>
          
          <!-- èƒŒæ™¯éŸ³æ¨‚ -->
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm font-medium text-[var(--color-text)]">èƒŒæ™¯éŸ³æ¨‚</div>
            </div>
            <button
              @click="settingsStore.toggleMusic()"
              class="toggle-switch"
              :class="{ 'toggle-on': settingsStore.musicEnabled }"
            >
              <span class="toggle-thumb"></span>
            </button>
          </div>
        </div>

        <!-- æé†’è¨­å®š -->
        <div class="card p-4">
          <h3 class="font-semibold text-[var(--color-text)] mb-4">ğŸ”” æé†’è¨­å®š</h3>

          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm font-medium text-[var(--color-text)]">æ¯æœˆè©•ä¼°æé†’</div>
              <div class="text-xs text-[var(--color-text-muted)]">è·é›¢ä¸Šæ¬¡ Mini-Cog/è©•ä¼°è¶…é 30 å¤©æœƒæé†’</div>
            </div>
            <button
              @click="settingsStore.assessmentReminderEnabled = !settingsStore.assessmentReminderEnabled"
              class="toggle-switch"
              :class="{ 'toggle-on': settingsStore.assessmentReminderEnabled }"
            >
              <span class="toggle-thumb"></span>
            </button>
          </div>
        </div>

        <!-- å¸³è™Ÿè³‡è¨Š -->
        <div v-if="userStore.isLoggedIn" class="card p-4">
          <h3 class="font-semibold text-[var(--color-text)] mb-3">ğŸ‘¤ å¸³è™Ÿè³‡è¨Š</h3>
          
          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span class="text-[var(--color-text-muted)]">å§“å</span>
              <span class="text-[var(--color-text)]">{{ userStore.currentUser?.name }}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-[var(--color-text-muted)]">å¹´é½¡</span>
              <span class="text-[var(--color-text)]">{{ userStore.userAge }} æ­²</span>
            </div>
          </div>
          
          <button 
            @click="handleLogout" 
            class="btn btn-secondary w-full mt-4 py-2 text-sm"
          >
            åˆ‡æ›å¸³è™Ÿ
          </button>
        </div>

        <!-- è¨“ç·´çµ±è¨ˆ -->
        <div v-if="userStore.isLoggedIn && userStore.currentStats" class="card p-4">
          <h3 class="font-semibold text-[var(--color-text)] mb-3">ğŸ“Š è¨“ç·´çµ±è¨ˆ</h3>
          
          <div class="grid grid-cols-2 gap-3 text-sm">
            <div class="p-3 bg-[var(--color-surface-alt)] rounded-lg text-center">
              <div class="text-lg font-bold text-[var(--color-primary)]">{{ totalGamesPlayed }}</div>
              <div class="text-xs text-[var(--color-text-muted)]">éŠæˆ²æ¬¡æ•¸</div>
            </div>
            <div class="p-3 bg-[var(--color-surface-alt)] rounded-lg text-center">
              <div class="text-lg font-bold text-green-500">{{ userStore.currentStats.averageScore }}</div>
              <div class="text-xs text-[var(--color-text-muted)]">å¹³å‡åˆ†æ•¸</div>
            </div>
            <div class="p-3 bg-[var(--color-surface-alt)] rounded-lg text-center">
              <div class="text-lg font-bold text-purple-500">{{ formatPlayTime(userStore.currentStats.totalPlayTime) }}</div>
              <div class="text-xs text-[var(--color-text-muted)]">ç¸½æ™‚é•·</div>
            </div>
            <div class="p-3 bg-[var(--color-surface-alt)] rounded-lg text-center">
              <div class="text-lg font-bold text-orange-500">{{ userStore.currentStats.streak }}</div>
              <div class="text-xs text-[var(--color-text-muted)]">é€£çºŒå¤©æ•¸</div>
            </div>
          </div>
        </div>

        <!-- å…¶ä»–è¨­å®š -->
        <div class="card p-4">
          <h3 class="font-semibold text-[var(--color-text)] mb-3">âš™ï¸ å…¶ä»–</h3>
          
          <button 
            @click="resetWelcome" 
            class="btn btn-secondary w-full mb-2 py-2 text-sm"
          >
            é‡æ–°é¡¯ç¤ºæ­¡è¿ç•«é¢
          </button>
          
          <button 
            v-if="userStore.isLoggedIn"
            @click="confirmClearData" 
            class="btn btn-danger w-full py-2 text-sm"
          >
            æ¸…é™¤æ‰€æœ‰éŠæˆ²è¨˜éŒ„
          </button>
        </div>

        <!-- é—œæ–¼ -->
        <div class="card p-4">
          <div class="text-center text-sm">
            <img src="@/assets/logo.svg" alt="æ„›è­·è…¦" class="w-12 h-12 mx-auto mb-3" />
            <p class="font-semibold text-[var(--color-text)]">æ„›è­·è…¦ Al MindCare</p>
            <p class="text-[var(--color-text-muted)]">ç‰ˆæœ¬ 1.0.0</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { useRouter } from 'vue-router'
import { useUserStore, useSettingsStore, useGameStore } from '@/stores'
import { clearUserGameSessions } from '@/services/db'
import TrainingGoalSettings from '@/components/ui/TrainingGoalSettings.vue'
import { computed } from 'vue'
import { getTotalGamesPlayed } from '@/utils/trainingStats'

const router = useRouter()
const userStore = useUserStore()
const settingsStore = useSettingsStore()
const gameStore = useGameStore()

const totalGamesPlayed = computed(() => {
  return getTotalGamesPlayed(userStore.currentStats?.totalGamesPlayed, gameStore.sessions.length)
})

// æ ¼å¼åŒ–éŠç©æ™‚é–“
function formatPlayTime(seconds: number): string {
  if (seconds < 60) return `${seconds}ç§’`
  if (seconds < 3600) return `${Math.floor(seconds / 60)}åˆ†`
  const hours = Math.floor(seconds / 3600)
  return `${hours}æ™‚`
}

// ç™»å‡º
function handleLogout(): void {
  userStore.logout()
  localStorage.removeItem('brain-training-current-user')
  router.push('/login')
}

// é‡ç½®æ­¡è¿ç•«é¢
function resetWelcome(): void {
  settingsStore.resetWelcome()
  alert('ä¸‹æ¬¡é€²å…¥é¦–é æ™‚å°‡é¡¯ç¤ºæ­¡è¿ç•«é¢')
}

// ç¢ºèªæ¸…é™¤è³‡æ–™
async function confirmClearData(): Promise<void> {
  if (!userStore.currentUser) return
  
  const confirmed = confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰éŠæˆ²è¨˜éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')
  if (!confirmed) return
  
  try {
    await clearUserGameSessions(userStore.currentUser.id)
    await gameStore.loadUserSessions(userStore.currentUser.id)
    await userStore.updateStats({
      totalGamesPlayed: 0,
      totalPlayTime: 0,
      averageScore: 0,
      bestScores: {},
      lastPlayedAt: null,
      streak: 0,
    })
    alert('éŠæˆ²è¨˜éŒ„å·²æ¸…é™¤')
  } catch {
    alert('æ¸…é™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦')
  }
}
</script>

<style scoped>
/* Toggle Switch é–‹é—œæ¨£å¼ */
.toggle-switch {
  position: relative;
  width: 52px;
  height: 28px;
  border-radius: 9999px;
  background-color: var(--color-bg-muted, #e5e7eb);
  border: none;
  cursor: pointer;
  transition: background-color 0.2s ease;
  flex-shrink: 0;
  overflow: hidden;
}

.toggle-switch.toggle-on {
  background-color: var(--color-primary, #6366f1);
}

.toggle-thumb {
  position: absolute;
  top: 2px;
  left: 2px;
  width: 24px;
  height: 24px;
  background-color: white;
  border-radius: 50%;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  transition: transform 0.2s ease;
}

.toggle-switch.toggle-on .toggle-thumb {
  transform: translateX(24px);
}
</style>
